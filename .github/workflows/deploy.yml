name: Build and Deploy Frontend

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: â¬‡ï¸ Checkout Repository (Clean)
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      - name: ğŸ§¹ Clean Build Environment
        run: |
          echo "ğŸ—‘ï¸ Cleaning any existing artifacts..."
          rm -rf dist/ node_modules/ .vite/ .cache/
          echo "âœ… Environment cleaned"

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Install Dependencies (Fresh)
        run: |
          rm -rf node_modules package-lock.json
          npm install --no-cache --prefer-online

      - name: ğŸ—ï¸ Build Application (No Cache)
        run: |
          rm -rf dist/
          npm run build
        env:
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_API_PREFIX: ${{ vars.VITE_API_PREFIX }}
          VITE_ENVIRONMENT: production
          NODE_ENV: production

      - name: ğŸ§ª Verify Build Output
        run: |
          echo "ğŸ“ Build directory contents:"
          ls -la dist/
          echo "ğŸ“Š Build size:"
          du -sh dist/
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed - index.html not found"
            exit 1
          fi
          echo "âœ… Build verification passed"

      - name: ğŸ‹ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: image=moby/buildkit:buildx-stable-1

      - name: ğŸ”‘ Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: ğŸš€ Build and Push Docker Image (No Cache)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64
          no-cache: true
          pull: true
          build-args: |
            VITE_API_BASE_URL=${{ vars.VITE_API_BASE_URL }}
            VITE_API_PREFIX=${{ vars.VITE_API_PREFIX }}
            VITE_ENVIRONMENT=production
            NODE_ENV=production
          tags: |
            ghcr.io/rdemora2/front-site--tivix-performance-tracker:latest
            ghcr.io/rdemora2/front-site--tivix-performance-tracker:${{ github.sha }}

      - name: ğŸ›°ï¸ Deploy to VPS via SSH (No Cache)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "ğŸ”‘ Logging into GitHub Container Registry..."
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            echo "âœ… Logged in to VPS"
            
            cd /home/tivixadmin/tivix-vps-infra/docker/stacks/app-tivix-performance-tracker
            echo "ğŸ“‹ Current directory: $(pwd)"
            
            echo "ğŸ›‘ Stopping and removing current containers..."
            docker compose down --remove-orphans --volumes || true
            
            echo "ğŸ§¹ Cleaning all Docker cache and old images..."
            docker system prune -af --volumes
            docker builder prune -af
            
            echo "ğŸš€ Pulling latest images (no cache)..."
            docker compose pull --no-parallel frontend
            
            echo "ğŸ”„ Starting containers with complete recreate..."
            docker compose up -d --force-recreate --renew-anon-volumes frontend
            
            echo "â³ Waiting for container to be healthy..."
            sleep 15
            
            echo "ğŸ” Verifying deployment..."
            if docker compose ps frontend | grep -q "Up"; then
              echo "âœ… Container is running successfully"
            else
              echo "âŒ Container failed to start"
              docker compose logs --tail=50 frontend
              exit 1
            fi
            
            echo "ğŸ“Š Final container status:"
            docker compose ps frontend
            docker stats --no-stream frontend || true
            
            echo "ğŸ‰ Fresh deployment completed successfully!"
            echo "ï¿½ Deploy time: $(date)"
